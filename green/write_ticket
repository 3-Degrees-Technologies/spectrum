#!/bin/bash
# write_ticket command for Agent-Knowledge
# Automates: Agent brief -> Template selection -> Ticket creation -> Auto-validation

# Colors and emoji
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'
SUCCESS="‚úÖ"
ERROR="‚ùå"
WARNING="‚ö†Ô∏è"
INFO="üìã"
WORKING="üîÑ"
INPUT="üìù"
CREATE="üé´"
VALIDATE="‚ú®"
TEMPLATE="üìÑ"

# Usage check
if [ $# -lt 3 ]; then
    echo -e "${ERROR} Usage: ./write_ticket <type> <title> <brief> [parent_id] [domain]"
    echo -e "${INFO} Types: research, design, implementation, subtask, parent"
    echo -e "${INFO} Example: ./write_ticket implementation 'JWT Middleware' 'Need JWT validation middleware' SPE-9 Auth"
    echo -e "${INFO} Subtask: ./write_ticket subtask 'Fix API Route' 'Fix /currencies endpoint routing' SPE-100 API"
    echo -e "${INFO} Parent: ./write_ticket parent 'Auth System Epic' 'Coordinate authentication system implementation' '' Auth"
    echo -e "${INFO} Domain examples: Account, Balance, Auth, API, Provider, Quote"
    exit 1
fi

type_input="$1"
ticket_title_base="$2"
agent_brief="$3"
parent_id="$4"
domain="$5"

# Add domain prefix to title if domain is provided
if [ -n "$domain" ]; then
    ticket_title="[$domain] $ticket_title_base"
else
    ticket_title="$ticket_title_base"
fi

# Map type names
case $type_input in
    "research"|"1") ticket_type=1; type_name="Research" ;;
    "design"|"2") ticket_type=2; type_name="Design" ;;
    "implementation"|"3") ticket_type=3; type_name="Implementation" ;;
    "subtask"|"4") ticket_type=4; type_name="Subtask" ;;
    "parent"|"5") ticket_type=5; type_name="Parent" ;;
    *) echo -e "${ERROR} Invalid type. Use: research, design, implementation, subtask, or parent"; exit 1 ;;
esac

echo -e "${INFO} ${BLUE}Agent-Knowledge Ticket Creation Framework${NC}"
echo -e "${CREATE} Creating ${type_name} ticket: ${ticket_title}"
echo -e "${INFO} Brief: ${agent_brief}"
if [ -n "$parent_id" ]; then
    echo -e "${INFO} Parent: ${parent_id}"
fi
echo ""

# Step 2: Apply domain context and templates
echo -e "${TEMPLATE} Applying ${type_name} template..."
echo -e "${WORKING} Generating ticket content..."

# Helper function to get project prefix
get_project_prefix() {
    local config_file=".spectrum/linear_config.json"
    if [ -f "$config_file" ]; then
        python3 -c "import json; print(json.load(open('$config_file'))['project_prefix'])" 2>/dev/null || echo "SPE"
    else
        # Get from saber and create config if missing
        python3 .tools/saber.py config >/dev/null 2>&1
        if [ -f "$config_file" ]; then
            python3 -c "import json; print(json.load(open('$config_file'))['project_prefix'])" 2>/dev/null || echo "SPE"
        else
            echo "SPE"  # fallback
        fi
    fi
}

# Generate ticket description based on type
case $ticket_type in
    1) # Research Template
        ticket_description="# ${ticket_title}

**Objective**: Investigate and analyze ${agent_brief} to provide findings and recommendations.

**Investigation Scope**
${agent_brief}

**Research Methodology**
* Analyze existing Centro codebase and patterns
* Review relevant documentation and configurations
* Identify current state and potential issues
* Research best practices and industry standards
* Document findings with evidence and examples

**Key Investigation Areas**

* **Current State Analysis**: What is the existing implementation/configuration?
* **Issue Identification**: What problems or inefficiencies exist?
* **Pattern Analysis**: How do similar features work in Centro?
* **Best Practices**: What are recommended approaches for this domain?
* **Impact Assessment**: What are the implications of current state vs desired state?

**Deliverables**

* Investigation findings documented with evidence
* Current state analysis with specific examples
* Issues and inefficiencies identified and categorized
* Recommendations for improvements or solutions
* Research findings saved to appropriate location (e.g., log_summary/)

**Success Criteria**

* Thorough analysis completed and documented
* Key findings clearly articulated with supporting evidence
* Recommendations provided based on research
* Documentation ready for follow-up planning or implementation

**Research Approach**
This is an investigation and analysis task - focus on understanding, documenting, and providing insights rather than implementing changes. Ask clarifying questions if the investigation scope needs refinement.

**Infrastructure Notice**
For database and infrastructure questions, coordinate with Agent-Black as needed.

**Labels**
research$([ -n "$domain" ] && echo ", $(echo "$domain" | tr '[:upper:]' '[:lower:]')")"
        ;;
    2) # Design Template
        ticket_description="# ${ticket_title}

**Objective**
Define the functional requirements and integration patterns for ${agent_brief}.

**Context**
Based on research findings, this design phase explores what ${agent_brief} should functionally accomplish and how it integrates with existing Centro systems.

**Task**
Explore and define the functional integration patterns for ${agent_brief}:

* How should this functionality integrate with existing Centro patterns?
* What contracts and interfaces should be defined?
* How should error handling and edge cases be managed?
* What operational visibility and monitoring is needed?
* How should this fit with existing Centro architectural patterns?

**Key Functional Questions to Answer**

* **Integration Flow**: What is the expected workflow and integration points?
* **Contracts**: What interfaces and contracts need to be defined?
* **Error Handling**: What failure modes exist and how should recovery work?
* **Observability**: What information do operators need for monitoring and debugging?
* **Centro Patterns**: How does this align with existing Centro architectural patterns?

**Success Criteria**

* Functional workflow defined with clear integration points
* Contracts and interfaces specified for consistent behavior
* Error handling and recovery patterns specified
* Operational monitoring and debugging requirements identified
* Integration approach with existing Centro systems documented
* Functional requirements ready for implementation planning

**Important Note for Implementation**
If any requirements are unclear or you need additional context, please ask clarifying questions rather than making assumptions. It's better to get confirmation on approach, scope, or technical details before implementation.

**Infrastructure Notice**
DO NOT attempt to access or modify databases directly. DO NOT attempt to change LocalStack configuration (centro-localstack:4566). For all database and infrastructure questions, contact Agent Black.

**Labels**
design$([ -n "$domain" ] && echo ", $(echo "$domain" | tr '[:upper:]' '[:lower:]')")"
        ;;
    3) # Implementation Template
        ticket_description="# ${ticket_title}

**Objective**: ${agent_brief}

**Task**: ${agent_brief}

**Implementation Approach**: Use test-driven development approach following existing Centro patterns.

**Definition of Done**:
* Implementation completed using test-driven development
* Core functionality implemented
* Code review completed and approved

**Testing Approach**:
* Use Test-Driven Development (TDD) - unit tests are written AS PART of implementation
* DO NOT create separate integration test suites or comprehensive integration testing
* Integration tests are ONLY for Bruno API test tickets or specific test harness creation
* All testing should be integrated into the implementation process using TDD methodology

**Important Note for Implementation**
If any requirements are unclear or you need additional context, please ask clarifying questions rather than making assumptions. It's better to get confirmation on approach, scope, or technical details before implementation.

**Infrastructure Notice**
DO NOT attempt to access or modify databases directly. DO NOT attempt to change LocalStack configuration (centro-localstack:4566). For all database and infrastructure questions, contact Agent Black.

**Labels**
backend$([ -n "$domain" ] && echo ", $(echo "$domain" | tr '[:upper:]' '[:lower:]')")"
        ;;
    4) # Subtask Template (minimal for breakdown subtasks)
        ticket_description="# ${ticket_title}

**Task**: ${agent_brief}

**Approach**: Follow existing Centro patterns and TDD methodology.

**Success Criteria**:
* Implementation complete and tested
* Code review approved

**Testing Approach**:
* Use Test-Driven Development (TDD) - unit tests are written AS PART of implementation
* DO NOT create separate integration test suites - use TDD methodology instead
* Integration tests are ONLY for Bruno API test tickets or test harness creation

**Infrastructure Notice**
DO NOT attempt to access or modify databases directly. DO NOT attempt to change LocalStack configuration (centro-localstack:4566). For all database and infrastructure questions, contact Agent Black.

**Labels**
backend$([ -n "$domain" ] && echo ", $(echo "$domain" | tr '[:upper:]' '[:lower:]')")"
        ;;
    5) # Parent Template (epic coordination)
        ticket_description="# ${ticket_title}

**Objective**: ${agent_brief}

## Strategic Overview

This epic coordinates the implementation of ${agent_brief} ensuring proper architectural separation and sequential execution of dependent work.

## Epic Structure

This epic coordinates the following implementation work:

### Phase 1: Foundation
- **CEN-XXX**: [Child Title] - [Child purpose]
- **CEN-YYY**: [Child Title] - [Child purpose]

### Phase 2: Implementation  
- **CEN-ZZZ**: [Child Title] - [Child purpose]
- **CEN-AAA**: [Child Title] - [Child purpose]

## Dependencies & Sequencing

**Foundation Dependencies**:
* [List prerequisite tickets or infrastructure]

**Sequential Flow**:
1. [First phase description] ‚Üí [Outcome enables next phase]
2. [Second phase description] ‚Üí [Final integration]

## Success Criteria

* ‚úÖ [Epic-level outcome 1]
* ‚úÖ [Epic-level outcome 2] 
* ‚úÖ [Epic-level outcome 3]
* ‚úÖ [Overall system integration working end-to-end]

## Coordination Notes

[Special considerations for managing this epic, architectural concerns, or coordination requirements]

**Labels**
epic$([ -n "$domain" ] && echo ", $(echo "$domain" | tr '[:upper:]' '[:lower:]')")"
        ;;
esac

# Step 3: Show draft and get clarification
echo ""
echo -e "${INFO} ${BLUE}=== TICKET DRAFT PREVIEW ===${NC}"
echo -e "${INFO} Title: ${ticket_title}"
echo -e "${INFO} Type: ${type_name}"
if [ -n "$parent_id" ]; then
    echo -e "${INFO} Parent: ${parent_id}"
fi
echo ""
echo -e "${INFO} Description:"
echo "$ticket_description"
echo ""
echo -e "${INFO} ${BLUE}=== END DRAFT PREVIEW ===${NC}"

# Step 3.5: Auto-proceed with ticket creation
echo -e "${WORKING} Proceeding with ticket creation..."

# Step 4: Create draft ticket first
echo -e "${WORKING} Creating draft ticket..."
create_result=$(python3 .tools/saber.py create "$ticket_title" "$ticket_description" 2>/dev/null)
if [ $? -ne 0 ]; then
    echo -e "${ERROR} Failed to create ticket"
    exit 1
fi

# Extract ticket ID from result
project_prefix=$(get_project_prefix)
ticket_id=$(echo "$create_result" | grep -oE "${project_prefix}-[0-9]+|CEN-[0-9]+" | head -1)
if [ -z "$ticket_id" ]; then
    # Try alternative extraction
    ticket_id=$(echo "$create_result" | grep -oE "[A-Z]+-[0-9]+" | head -1)
    if [ -z "$ticket_id" ]; then
        echo -e "${ERROR} Could not extract ticket ID from creation result"
        echo -e "${INFO} Create result: $create_result"
        exit 1
    fi
fi

echo -e "${SUCCESS} Draft ticket created: ${ticket_id}"

# Apply labels based on type and domain
echo -e "${WORKING} Applying labels..."
labels_to_add=""
case $ticket_type in
    1) labels_to_add="research" ;;
    2) labels_to_add="design" ;;
    3) labels_to_add="backend" ;;
    4) labels_to_add="backend" ;;
    5) labels_to_add="epic" ;;
esac

# Add domain label if provided
if [ -n "$domain" ]; then
    domain_label=$(echo "$domain" | tr '[:upper:]' '[:lower:]')
    labels_to_add="${labels_to_add},${domain_label}"
fi

# Apply labels to the ticket
if [ -n "$labels_to_add" ]; then
    label_result=$(python3 .tools/saber.py label "$ticket_id" add "$labels_to_add" 2>/dev/null)
    if [ $? -eq 0 ]; then
        echo -e "${SUCCESS} Labels applied: ${labels_to_add}"
    else
        echo -e "${WARNING} Failed to apply labels: ${labels_to_add}"
    fi
fi

# Set parent relationship if provided
if [ -n "$parent_id" ]; then
    echo -e "${WORKING} Setting parent relationship to ${parent_id}..."
    parent_result=$(python3 .tools/saber.py parent "$ticket_id" "$parent_id" 2>/dev/null)
    if [ $? -eq 0 ]; then
        echo -e "${SUCCESS} Parent relationship set"
    else
        echo -e "${WARNING} Failed to set parent relationship"
    fi
fi

# Step 4.5: Draft created, encourage questions
echo ""
echo -e "${SUCCESS} ${GREEN}Draft ticket ${ticket_id} created!${NC}"
echo -e "${INPUT} ${YELLOW}Now is the time to ask clarifying questions to improve this ticket.${NC}"
echo -e "${INPUT} Consider asking about:"
echo -e "${INFO}   ‚Ä¢ Technical implementation details (async vs sync, error handling)"
echo -e "${INFO}   ‚Ä¢ Integration requirements and patterns to follow"
echo -e "${INFO}   ‚Ä¢ Scope boundaries and what should be included/excluded" 
echo -e "${INFO}   ‚Ä¢ Dependencies on other systems or infrastructure"
echo -e "${INFO}   ‚Ä¢ Success criteria or specific acceptance criteria"
echo ""
echo -e "${WARNING} ${YELLOW}üéØ MVP/KISS Review - Critical Questions:${NC}"
echo -e "${INFO}   ‚Ä¢ What's the SIMPLEST version that delivers value?"
echo -e "${INFO}   ‚Ä¢ Can any features be moved to future tickets?"
echo -e "${INFO}   ‚Ä¢ Are we solving the core problem or gold-plating?"
echo -e "${INFO}   ‚Ä¢ What would the 'basic working version' look like?"
echo -e "${INFO}   ‚Ä¢ Which requirements are must-have vs nice-to-have?"
echo ""
echo -e "${INPUT} Use: ${BLUE}saber.py description ${ticket_id} \"improved description\"${NC} to update"
echo -e "${INPUT} Then continue with assignment when satisfied with ticket quality"
echo ""

# Step 6: Optional validation if script exists
if [ -f "./validate_ticket" ]; then
    echo -e "${VALIDATE} Validation available - run: ${BLUE}./validate_ticket ${ticket_id}${NC}"
fi

# Step 7: Creation complete
echo -e "${SUCCESS} ${GREEN}Draft Ticket Creation Complete!${NC}"
echo -e "${INFO} Ticket ID: ${ticket_id}"
echo -e "${INFO} Title: ${ticket_title}"
echo -e "${INFO} Type: ${type_name}"
if [ -n "$parent_id" ]; then
    echo -e "${INFO} Parent: ${parent_id}"
fi
echo -e "${INFO} Linear URL: https://linear.app/3-degrees-technologies/issue/${ticket_id}"
echo -e "${WARNING} ${YELLOW}Remember: This is a DRAFT - refine with questions before assignment!${NC}"