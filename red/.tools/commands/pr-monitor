#!/bin/bash
# pr-monitor command for Spectrum Development Framework
# Phase 2: Monitor PR feedback and handle iterations using Cotejar tools

# Colors and emoji
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'
SUCCESS="‚úÖ"
ERROR="‚ùå"
INFO="üìã"
WORKING="üîÑ"
MONITOR="üëÅÔ∏è"
FEEDBACK="üí¨"

echo -e "${MONITOR} ${BLUE}PR MONITOR${NC}: Monitoring PR feedback and CI/CD status"

# Check if we're in a ticket workflow
SPECTRUM_STATE_DIR=".spectrum/state"
SPECTRUM_TMP_DIR=".spectrum/tmp"
CURRENT_TICKET_FILE="$SPECTRUM_STATE_DIR/current-ticket.json"

# Ensure Spectrum directory structure exists
mkdir -p "$SPECTRUM_STATE_DIR" "$SPECTRUM_TMP_DIR"

if [[ ! -f "$CURRENT_TICKET_FILE" ]]; then
    echo -e "${ERROR} No active ticket workflow found"
    echo -e "${INFO} Please ensure you've created a PR with './.tools/commands/pr-ready' first"
    exit 1
fi

# Load current ticket context
ticket_info=$(cat "$CURRENT_TICKET_FILE")
ticket_id=$(echo "$ticket_info" | jq -r '.ticket')
ticket_title=$(echo "$ticket_info" | jq -r '.title')
pr_url=$(echo "$ticket_info" | jq -r '.pr_url // empty')
current_phase=$(echo "$ticket_info" | jq -r '.phase')

# Validate we're in a valid PR phase
if [[ "$current_phase" != "pr-created" && "$current_phase" != "pr-monitoring" && "$current_phase" != "pr-iteration" && "$current_phase" != "pr-ready-for-merge" ]]; then
    echo -e "${ERROR} Invalid workflow phase: $current_phase"
    echo -e "${INFO} Expected: pr-created, pr-monitoring, pr-iteration, or pr-ready-for-merge"
    echo -e "${INFO} Current ticket: $ticket_id"
    exit 1
fi

if [[ -z "$pr_url" || "$pr_url" == "null" ]]; then
    echo -e "${ERROR} No PR URL found in ticket state"
    echo -e "${INFO} Please ensure PR was created successfully with pr-ready"
    exit 1
fi

echo -e "${INFO} Monitoring PR: ${BLUE}$ticket_id${NC} - $ticket_title"
echo -e "${INFO} PR URL: $pr_url"

# Extract GitHub repo info from PR URL
if [[ "$pr_url" =~ github\.com/([^/]+)/([^/]+)/pull/([0-9]+) ]]; then
    repo_owner="${BASH_REMATCH[1]}"
    repo_name="${BASH_REMATCH[2]}"
    pr_number="${BASH_REMATCH[3]}"
else
    echo -e "${ERROR} Could not parse GitHub repo info from PR URL: $pr_url"
    exit 1
fi

echo -e "${INFO} Repository: $repo_owner/$repo_name (PR #$pr_number)"

# Update ticket state to monitoring phase
jq '.phase = "pr-monitoring" | .monitoring_started = now | .monitoring_started |= todate' $CURRENT_TICKET_FILE > $CURRENT_TICKET_FILE.tmp
mv $CURRENT_TICKET_FILE.tmp $CURRENT_TICKET_FILE

echo -e "\n${MONITOR} ${YELLOW}Using Cotejar tools for comprehensive PR monitoring:${NC}"
echo ""

# Phase 2a: Get PR Summary
echo -e "${WORKING} Getting PR summary..."
echo -e "${INFO} ${YELLOW}AI Agent: Getting comprehensive PR status with Cotejar tools:${NC}"
echo ""
echo -e "${YELLOW}=== REQUIRED: Use Cotejar PR Summary Tool ===${NC}"
echo -e "${INFO} Run this command to get overall PR health:"
echo "  cotejar summary $repo_owner/$repo_name#$pr_number"
echo ""
echo -e "${YELLOW}=== REQUIRED: Get PR Feedback/Comments ===${NC}"
echo -e "${INFO} Run this command to get review comments and feedback:"
echo "  cotejar feedback $repo_owner/$repo_name#$pr_number"
echo ""

# AI Agent: Automatically proceed with PR monitoring
echo -e "${INFO} Proceeding with automated PR monitoring..."

# Phase 2b: Check for blocking issues
echo -e "\n${WORKING} Checking for blocking issues..."
echo -e "${INFO} ${YELLOW}AI Agent: Check for merge-blocking issues:${NC}"
echo ""
echo -e "${YELLOW}=== REQUIRED: Check Blocking Issues ===${NC}"
echo -e "${INFO} Run this command to identify issues preventing merge:"
echo "  cotejar blocking $repo_owner/$repo_name#$pr_number"
echo ""
echo -e "${INFO} Look for:"
echo "  üîí Security issues (blocking)"
echo "  üî® Failed CI/CD workflows (blocking)"
echo "  üß™ Test failures (blocking)"
echo "  üí¨ Unresolved review conversations (may be blocking)"
echo ""

# AI Agent: Automatically check for blocking issues using available tools
echo -e "${INFO} AI Agent: Checking for blocking issues automatically..."

# Actually check for blocking issues using cotejar
echo -e "${WORKING} Running: cotejar blocking $repo_owner/$repo_name#$pr_number"
blocking_output=$(cotejar blocking $repo_owner/$repo_name#$pr_number 2>&1)
blocking_exit_code=$?

if [[ $blocking_exit_code -ne 0 ]] || echo "$blocking_output" | grep -qi "‚ùå.*blocking\|failed\|error\|critical"; then
    has_blocking_issues="y"
    echo -e "${ERROR} Blocking issues detected:"
    echo "$blocking_output"
else
    has_blocking_issues="n"
    echo -e "${SUCCESS} No critical blocking issues detected - proceeding with merge readiness check"
fi

if [[ "$has_blocking_issues" == "y" || "$has_blocking_issues" == "Y" ]]; then
    echo -e "\n${FEEDBACK} ${YELLOW}Blocking issues detected - entering fix iteration mode${NC}"
    
    # Phase 2c: Get detailed feedback for fixes
    echo -e "\n${WORKING} Getting detailed feedback for issue resolution..."
    echo -e "${INFO} ${YELLOW}AI Agent: Get detailed feedback for specific categories:${NC}"
    echo ""
    echo -e "${YELLOW}=== ANALYZE FEEDBACK BY CATEGORY ===${NC}"
    echo -e "${INFO} Use these Cotejar commands to get specific feedback:"
    echo ""
    echo "  # For CI/CD issues:"
    echo "  cotejar category --type=ci-cd $repo_owner/$repo_name#$pr_number"
    echo ""
    echo "  # For security issues:"
    echo "  cotejar category --type=security $repo_owner/$repo_name#$pr_number"
    echo ""
    echo "  # For code quality issues:"
    echo "  cotejar category --type=quality $repo_owner/$repo_name#$pr_number"
    echo ""
    echo "  # For failed GitHub Actions:"
    echo "  cotejar workflows $repo_owner/$repo_name#$pr_number"
    echo ""
    echo "  # For review conversations:"
    echo "  cotejar feedback $repo_owner/$repo_name#$pr_number"
    echo ""
    
    # AI Agent: Automatically proceed with feedback analysis
    echo -e "${INFO} AI Agent: Proceeding with automated feedback analysis..."
    
    # Guide through fix iteration
    echo -e "\n${INFO} ${GREEN}Fix Iteration Workflow:${NC}"
    echo ""
    echo -e "${YELLOW}1. Address Issues Using TDD (if code changes needed):${NC}"
    echo "   ./.tools/commands/tdd-red 'fix specific issue'"
    echo "   ./.tools/commands/tdd-green"
    echo "   ./.tools/commands/tdd-commit 'Fix: issue description'"
    echo ""
    echo -e "${YELLOW}2. Push Updates:${NC}"
    echo "   git push origin $(git branch --show-current)"
    echo "   (Pre-commit hooks will enforce quality automatically)"
    echo ""
    echo -e "${YELLOW}3. Monitor Again:${NC}"
    echo "   ./.tools/commands/pr-monitor"
    echo ""
    echo -e "${YELLOW}4. Mark Conversations Resolved (if applicable):${NC}"
    echo "   cotejar resolve --repo $repo_owner/$repo_name#$pr_number <thread-id>"
    echo ""
    
    # Update state to iteration mode
    jq '.phase = "pr-iteration" | .iteration_started = now | .iteration_started |= todate' $CURRENT_TICKET_FILE > $CURRENT_TICKET_FILE.tmp
    mv $CURRENT_TICKET_FILE.tmp $CURRENT_TICKET_FILE
    
    echo -e "${INFO} ${BLUE}Status updated to: PR Iteration Mode${NC}"
    echo -e "${SUCCESS} Re-run this command after making fixes to continue monitoring"
    
else
    echo -e "\n${SUCCESS} ${GREEN}No blocking issues found!${NC}"
    
    # Get actual feedback since there are no blocking issues
    echo -e "\n${WORKING} Getting PR feedback and comments..."
    echo -e "${INFO} Running: cotejar feedback $repo_owner/$repo_name#$pr_number"
    feedback_output=$(cotejar feedback $repo_owner/$repo_name#$pr_number 2>&1)
    feedback_exit_code=$?
    
    if [[ $feedback_exit_code -eq 0 ]]; then
        echo -e "${SUCCESS} PR feedback retrieved:"
        echo "$feedback_output"
    else
        echo -e "${ERROR} Failed to get feedback:"
        echo "$feedback_output"
    fi
    
    # Phase 2d: Check if PR is ready for merge
    echo -e "\n${WORKING} Final readiness check..."
    echo -e "${INFO} ${YELLOW}AI Agent: Verify PR is ready for merge:${NC}"
    echo ""
    echo -e "${YELLOW}=== FINAL READINESS CHECK ===${NC}"
    echo -e "${INFO} Confirm all criteria met:"
    echo "  ‚úÖ All CI/CD workflows passing"
    echo "  ‚úÖ No security warnings"
    echo "  ‚úÖ All tests passing"
    echo "  ‚úÖ Code review completed"
    echo "  ‚úÖ All conversations resolved"
    echo ""
    
    # AI Agent: Automatically assume PR is ready if no blocking issues found
    echo -e "${INFO} AI Agent: Assuming PR is ready for merge (no blocking issues detected)"
    ready_for_merge="y"
    
    if [[ "$ready_for_merge" == "y" || "$ready_for_merge" == "Y" ]]; then
        # Update state to ready for merge
        jq '.phase = "pr-ready-for-merge" | .ready_for_merge_at = now | .ready_for_merge_at |= todate' $CURRENT_TICKET_FILE > $CURRENT_TICKET_FILE.tmp
        mv $CURRENT_TICKET_FILE.tmp $CURRENT_TICKET_FILE
        
        echo -e "\n${SUCCESS} ${GREEN}PR READY FOR MERGE${NC}"
        echo -e "${INFO} Summary:"
        echo "  üìã Ticket: $ticket_id - $ticket_title"
        echo "  üîÄ PR: #$pr_number ($pr_url)"
        echo "  ‚úÖ All quality gates passed"
        echo "  ‚úÖ No blocking issues"
        echo "  ‚úÖ Ready for team merge"
        echo ""
        echo -e "${INFO} ${GREEN}Next steps:${NC}"
        echo "  1. üë• Coordinate with team for PR merge"
        echo "  2. üöÄ Wait for merge to dev ‚Üí staging deployment"
        echo "  3. üßπ After merge: ./.tools/commands/pr-cleanup"
        echo ""
        echo -e "${YELLOW} Note: PR cleanup should only be done AFTER the PR is merged${NC}"
        
    else
        echo -e "\n${INFO} ${YELLOW}PR not yet ready for merge${NC}"
        echo -e "${INFO} Continue monitoring and addressing feedback as needed"
        echo -e "${INFO} Re-run './.tools/commands/pr-monitor' when status changes"
    fi
fi

echo -e "\n${MONITOR} ${BLUE}PR monitoring session complete${NC}"
echo -e "${INFO} Current status: $(jq -r '.phase' $CURRENT_TICKET_FILE)"