#!/bin/bash
# Spectrum AI Agent Launcher for Workspace-Based Development

set -e

# Load agent names from configuration
get_agent_name() {
    local color="$1"
    if [[ -f ".spectrum/agent-names.json" ]]; then
        # Try to extract agent name from JSON
        local agent_key="AGENT_${color^^}"  # Convert to uppercase
        if command -v jq >/dev/null 2>&1; then
            jq -r ".$agent_key // \"Agent-${color^}\"" .spectrum/agent-names.json 2>/dev/null || echo "Agent-${color^}"
        else
            # Fallback: simple grep extraction
            grep "\"$agent_key\"" .spectrum/agent-names.json 2>/dev/null | sed 's/.*": *"\([^"]*\)".*/\1/' || echo "Agent-${color^}"
        fi
    else
        echo "Agent-${color^}"
    fi
}

# Parse command
if [[ $# -lt 1 ]]; then
    echo "Usage: agent <color>"
    echo ""
    echo "Spectrum AI Agent Conventions:"
    echo "  green   â†’ $(get_agent_name green) in ./green"
    echo "  red     â†’ $(get_agent_name red) in ./red"
    echo "  blue    â†’ $(get_agent_name blue) in ./blue"
    echo "  blue    â†’ $(get_agent_name black) in ./black"
    exit 1
fi

AGENT_COLOR="$1"

# Handle scarlet alias
if [[ "$AGENT_COLOR" == "scarlet" ]]; then
    AGENT_COLOR="red"
fi

# Convention-based directory mapping
case "$AGENT_COLOR" in
    "green")
        AGENT_NAME="$(get_agent_name green)"
        WORK_DIR="./green"
        ;;
    "red")  
        AGENT_NAME="$(get_agent_name red)"
        WORK_DIR="./red"
        # Ensure red directory exists
        if [[ ! -d "./red" ]]; then
            echo "ðŸ“ Creating red directory for $AGENT_NAME..."
            mkdir -p "./red"
        fi
        ;;
    "blue")
        AGENT_NAME="$(get_agent_name blue)"
        WORK_DIR="./blue"
        # Ensure blue directory exists
        if [[ ! -d "./blue" ]]; then
            echo "ðŸ“ Creating blue directory for $AGENT_NAME..."
            mkdir -p "./blue"
        fi
        ;;
    "black")
        AGENT_NAME="$(get_agent_name black)"
        WORK_DIR="./black"
        # Ensure black directory exists
        if [[ ! -d "./black" ]]; then
            echo "ðŸ“ Creating black directory for $AGENT_NAME..."
            mkdir -p "./black"
        fi
        ;;
    *)
        echo "âŒ Unknown agent: $AGENT_COLOR"
        echo "Available: green, red, blue, black"
        exit 1
        ;;
esac

echo "ðŸ¤– Starting OpenCode session with $AGENT_NAME..."
echo "ðŸ“ Working directory: $WORK_DIR"

# Check if opencode is available
if ! command -v opencode >/dev/null 2>&1; then
    echo "âŒ OpenCode not found in PATH"
    echo "   Please ensure OpenCode is installed and available in your PATH"
    exit 1
fi

# Change to the agent's working directory and start OpenCode
cd "$WORK_DIR"

# Add .tools directory to PATH if it exists
if [[ -d ".tools" ]]; then
    export PATH="$(pwd)/.tools:$PATH"
fi

# Set up automatic agent registration in the background
setup_auto_registration() {
    local color="$1"
    
    # Create a background script that waits for OpenCode to start, then registers
    cat > /tmp/auto-register-${color}-$$.sh << 'EOF'
#!/bin/bash
AGENT_COLOR="$1"
WORK_DIR="$2"

# Wait for OpenCode to start and get a port (max 30 seconds)
for i in {1..30}; do
    sleep 1
    
    # Look for this process's OpenCode port
    OPENCODE_PID=$PPID
    PORT=$(netstat -tulnp 2>/dev/null | grep "$OPENCODE_PID/opencode" | awk '{print $4}' | cut -d: -f2 | head -1)
    
    if [[ -n "$PORT" ]]; then
        
        # Change to the agent directory to run the registration script
        cd "$WORK_DIR"
        
        # Run the registration script if it exists
        if [[ -f ".tools/agent-register.sh" ]]; then
            .tools/agent-register.sh --color "$AGENT_COLOR" --port "$PORT" 2>/dev/null || true
        fi
        break
    fi
done

# Clean up this script
rm -f "/tmp/auto-register-${AGENT_COLOR}-$$.sh"
EOF
    
    chmod +x "/tmp/auto-register-${color}-$$.sh"
    
    # Start the registration script in the background
    "/tmp/auto-register-${color}-$$.sh" "$color" "$(pwd)" &
}

echo "ðŸš€ Starting OpenCode in $(pwd)..."

# Set up auto-registration before starting OpenCode
if [[ -f ".tools/agent-register.sh" ]]; then
    echo "ðŸ”— Setting up automatic Slack notification registration..."
    setup_auto_registration "$AGENT_COLOR"
fi

exec opencode
