#!/bin/bash
# bulk_breakdown command for Agent-Knowledge
# Automates: Complex task -> Breakdown analysis -> Multiple ticket creation -> Validation -> Refinement prompts

# Colors and emoji
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'
SUCCESS="‚úÖ"
ERROR="‚ùå"
WARNING="‚ö†Ô∏è"
INFO="üìã"
WORKING="üîÑ"
ANALYZE="üîç"
CREATE="üé´"
VALIDATE="‚ú®"
BULK="üì¶"

# Usage check
if [ $# -lt 1 ]; then
    echo -e "${ERROR} Usage: ./bulk_breakdown <command> [args...]"
    echo -e "${INFO} Commands:"
    echo -e "${INFO}   analyze <title> [description] - Generate systematic breakdown analysis"
    echo -e "${INFO}   plan <analysis_file> - Create breakdown specification from analysis"
    echo -e "${INFO}   epic <title> [description] - Research + Implementation phases"
    echo -e "${INFO}   implementation <title> [description] [parent] - Split large implementation"
    echo -e "${INFO}   split <parent_id> - Break down existing ticket that failed validation"
    echo -e "${INFO} Examples:"
    echo -e "${INFO}   ./bulk_breakdown analyze 'API Rewrite' 'Convert to GraphQL'"
    echo -e "${INFO}   ./bulk_breakdown plan /tmp/api_rewrite_analysis.md"
    echo -e "${INFO}   ./bulk_breakdown epic 'API Rewrite' 'Convert to GraphQL'"
    echo -e "${INFO}   ./bulk_breakdown implementation 'CLI Framework' 'Click + config + auth' CEN-10"
    echo -e "${INFO}   ./bulk_breakdown split CEN-15"
    exit 1
fi

command="$1"
title="$2"
description="${3:-}"
parent_id="${4:-}"

echo -e "${BULK} ${BLUE}Agent-Knowledge Bulk Breakdown Framework${NC}"
echo "‚ú® Processing ${command}: ${title}"
echo ""

case "$command" in
    "analyze")
        if [ -z "$title" ]; then
            echo -e "${ERROR} Title required for analysis"
            exit 1
        fi
        
        echo -e "${ANALYZE} Generating systematic breakdown analysis..."
        
        # Create analysis template
        analysis_file="/tmp/breakdown_analysis_$(date +%s).md"
        
        cat > "$analysis_file" << 'ANALYSIS_TEMPLATE'
# Breakdown Analysis Template

## üìã **Task Overview**
**Title:** TASK_TITLE
**Description:** TASK_DESCRIPTION

## üîç **Complexity Analysis**

### **Business Domain Analysis**
- [ ] **Single Business Domain**: Does this task focus on ONE core business capability?
  - Authentication/Authorization
  - File Discovery/Management  
  - Audio Streaming
  - User Interface/Experience
  - Data Storage/Sync
  - External Integration
  - Other: ___________

- [ ] **Multiple Business Domains**: List if task spans multiple business areas:
  - Domain 1: ___________
  - Domain 2: ___________
  - Domain 3: ___________

### **Technical Domain Analysis**  
Count technical domains involved:
- [ ] Android UI Components
- [ ] API Client/Network
- [ ] Database/Storage
- [ ] Background Services
- [ ] File System Operations
- [ ] Audio Processing
- [ ] Authentication Systems
- [ ] External Integration
- [ ] Configuration/Settings
- [ ] Testing/Validation
- [ ] Performance/Optimization
- [ ] Other: ___________

**Technical Domain Count:** ___ (2-4 acceptable, 5+ suggests breakdown)

### **Implementation Scope Analysis**
- [ ] **Single Implementation Context**: Can this be implemented in one focused coding session?
- [ ] **Multiple Implementation Contexts**: Requires work across multiple:
  - [ ] Different codebases
  - [ ] Different architectural layers
  - [ ] Different development phases
  - [ ] Different skill sets

### **Task Decomposition Check**
Count distinct implementable tasks:
1. ___________
2. ___________
3. ___________
4. ___________
5. ___________

**Task Count:** ___ (1-3 good, 4+ suggests breakdown)

## üéØ **Breakdown Recommendation**

### **Assessment Result:**
- [ ] **‚úÖ GOOD SCOPE**: Single domain, focused task, ready for implementation
- [ ] **‚ö†Ô∏è NEEDS REFINEMENT**: Some complexity but manageable with clarification  
- [ ] **‚ùå BREAKDOWN REQUIRED**: Multiple domains/tasks, too complex for single ticket

### **Breakdown Type Recommendation:**
- [ ] **Epic Breakdown**: Research ‚Üí Implementation phases needed
- [ ] **Implementation Breakdown**: Large implementation ‚Üí focused subtasks
- [ ] **Domain Separation**: Multiple business domains ‚Üí separate domain tickets
- [ ] **Context Separation**: Multiple implementation contexts ‚Üí separate context tickets

### **Proposed Structure:**
```
Parent Ticket: [Title]
‚îú‚îÄ‚îÄ Subtask 1: [Specific Area]
‚îú‚îÄ‚îÄ Subtask 2: [Specific Area]  
‚îú‚îÄ‚îÄ Subtask 3: [Specific Area]
‚îî‚îÄ‚îÄ Subtask 4: [Specific Area]
```

## üìù **Implementation Notes**
- **Prerequisites**: ___________
- **Dependencies**: ___________
- **Integration Points**: ___________
- **Risk Areas**: ___________

## ‚úÖ **Quality Gates**
- [ ] Each subtask focuses on single implementation context
- [ ] Each subtask has clear deliverable
- [ ] Dependencies between subtasks identified
- [ ] Parent ticket coordination approach defined
ANALYSIS_TEMPLATE

        # Replace placeholders
        sed -i "s/TASK_TITLE/$title/g" "$analysis_file"
        sed -i "s/TASK_DESCRIPTION/${description:-No description provided}/g" "$analysis_file"
        
        echo -e "${SUCCESS} Analysis template created: $analysis_file"
        echo ""
        echo -e "${INFO} ${BLUE}=== NEXT STEPS ===${NC}"
        echo -e "${INFO} 1. Edit the analysis file to complete the assessment:"
        echo -e "${INFO}    ${analysis_file}"
        echo -e "${INFO} 2. After completing analysis, generate breakdown plan:"
        echo -e "${INFO}    ./bulk_breakdown plan ${analysis_file}"
        echo -e "${BLUE}=========================${NC}"
        ;;
        
    "plan")
        if [ -z "$title" ] || [ ! -f "$title" ]; then
            echo -e "${ERROR} Valid analysis file required for planning"
            exit 1
        fi
        
        analysis_file="$title"
        echo -e "${ANALYZE} Generating breakdown plan from analysis..."
        
        # Extract key information from analysis
        breakdown_type_line=$(grep -A 5 "Breakdown Type Recommendation" "$analysis_file" | grep -E "\[x\]|\[X\]" | head -1)
        
        if [[ $breakdown_type_line == *"Epic Breakdown"* ]]; then
            breakdown_type="epic"
        elif [[ $breakdown_type_line == *"Implementation Breakdown"* ]]; then
            breakdown_type="implementation"  
        elif [[ $breakdown_type_line == *"Domain Separation"* ]]; then
            breakdown_type="domain"
        elif [[ $breakdown_type_line == *"Context Separation"* ]]; then
            breakdown_type="context"
        else
            echo -e "${ERROR} No breakdown type selected in analysis file"
            echo -e "${INFO} Please mark one breakdown type recommendation with [x]"
            exit 1
        fi
        
        # Create breakdown plan
        plan_file="/tmp/breakdown_plan_$(date +%s).md"
        task_title=$(grep "Title:" "$analysis_file" | cut -d' ' -f2-)
        
        # Extract proposed structure for better subtask naming
        proposed_structure=$(awk '/### \*\*Proposed Structure:\*\*/{flag=1; next} /##/{flag=0} flag' "$analysis_file")
        
        cat > "$plan_file" << PLAN_HEADER
# Breakdown Execution Plan

## Source Analysis
**File:** $analysis_file
**Task:** $task_title
**Breakdown Type:** $breakdown_type

## Proposed Structure
$proposed_structure

## Execution Commands
PLAN_HEADER

        case "$breakdown_type" in
            "epic")
                cat >> "$plan_file" << 'EPIC_PLAN'

### Epic Structure Creation
```bash
# 1. Create epic parent
./write_ticket research "TASK_TITLE Epic" "Epic coordination ticket"

# 2. Create research phase  
./write_ticket research "TASK_TITLE Architecture Research" "Research and design phase" EPIC_ID

# 3. Create implementation parent
./write_ticket implementation "TASK_TITLE Implementation" "Implementation coordination" EPIC_ID

# 4. Create implementation subtasks
./write_ticket implementation "TASK_TITLE Core Framework" "Core implementation" IMPL_PARENT_ID
./write_ticket implementation "TASK_TITLE Integration Layer" "Integration implementation" IMPL_PARENT_ID
./write_ticket implementation "TASK_TITLE Business Logic" "Business logic implementation" IMPL_PARENT_ID
```

### Dependencies
```bash
# Implementation parent depends on research completion
./depend add IMPL_PARENT_ID blocked-by RESEARCH_ID
```
EPIC_PLAN
                ;;
            "implementation")
                # Extract specific subtasks from the proposed structure
                subtask_1=$(echo "$proposed_structure" | grep "Subtask 1:" | sed 's/.*Subtask 1: //' | sed 's/‚îú‚îÄ‚îÄ //')
                subtask_2=$(echo "$proposed_structure" | grep "Subtask 2:" | sed 's/.*Subtask 2: //' | sed 's/‚îú‚îÄ‚îÄ //')
                subtask_3=$(echo "$proposed_structure" | grep "Subtask 3:" | sed 's/.*Subtask 3: //' | sed 's/‚îú‚îÄ‚îÄ //')
                subtask_4=$(echo "$proposed_structure" | grep "Subtask 4:" | sed 's/.*Subtask 4: //' | sed 's/‚îî‚îÄ‚îÄ //')
                
                cat >> "$plan_file" << IMPL_PLAN

### Implementation Breakdown
\`\`\`bash
# 1. Convert existing ticket to parent (if splitting existing)
# python3 ./.tools/saber.py description PARENT_ID "Parent coordination description"

# 2. Create focused subtasks based on analysis
./write_ticket implementation "${subtask_1:-TASK_TITLE Component A}" "First focused implementation area" PARENT_ID
./write_ticket implementation "${subtask_2:-TASK_TITLE Component B}" "Second focused implementation area" PARENT_ID  
./write_ticket implementation "${subtask_3:-TASK_TITLE Component C}" "Third focused implementation area" PARENT_ID
./write_ticket implementation "${subtask_4:-TASK_TITLE Integration}" "Integration and testing implementation" PARENT_ID
\`\`\`
IMPL_PLAN
                ;;
            "domain"|"context")
                cat >> "$plan_file" << 'SEPARATION_PLAN'

### Domain/Context Separation
```bash
# Create separate tickets for each domain/context
./write_ticket implementation "TASK_TITLE - Domain A" "First domain implementation"
./write_ticket implementation "TASK_TITLE - Domain B" "Second domain implementation"  
./write_ticket implementation "TASK_TITLE - Domain C" "Third domain implementation"
```

### Coordination (if needed)
```bash
# Create coordination parent if integration required
./write_ticket implementation "TASK_TITLE Coordination" "Integration coordination parent"
# Set domain tickets as children of coordination parent
```
SEPARATION_PLAN
                ;;
        esac
        
        cat >> "$plan_file" << 'PLAN_FOOTER'

## Validation Checklist
- [ ] All tickets created successfully
- [ ] Parent-child relationships established
- [ ] Dependencies configured
- [ ] Quality validation passed for each ticket
- [ ] Assignment plan ready

## Assignment Strategy
1. Start with research/analysis tickets
2. Block implementation on research completion
3. Assign implementation subtasks based on agent expertise
4. Coordinate integration and testing

## Notes
- Replace TASK_TITLE, EPIC_ID, PARENT_ID, etc. with actual values
- Run validation on each created ticket
- Consider agent workload when assigning
PLAN_FOOTER

        # Replace task title placeholder
        sed -i "s/TASK_TITLE/$task_title/g" "$plan_file"
        
        echo -e "${SUCCESS} Breakdown plan created: $plan_file"
        echo ""
        echo -e "${INFO} ${BLUE}=== NEXT STEPS ===${NC}"
        echo -e "${INFO} 1. Review the breakdown plan:"
        echo -e "${INFO}    ${plan_file}"
        echo -e "${INFO} 2. Execute the breakdown:"
        echo -e "${INFO}    ./bulk_breakdown execute ${plan_file}"
        echo -e "${BLUE}=========================${NC}"
        ;;
        
    "execute")
        if [ -z "$title" ] || [ ! -f "$title" ]; then
            echo -e "${ERROR} Valid breakdown plan file required for execution"
            exit 1
        fi
        
        plan_file="$title"
        echo -e "${ANALYZE} Executing breakdown plan: $plan_file"
        
        # Extract and execute commands from plan file
        echo -e "${WORKING} Extracting execution commands..."
        
        # Find code blocks with bash commands
        temp_script="/tmp/breakdown_execute_$(date +%s).sh"
        
        # Extract commands between ```bash and ``` markers
        awk '/```bash/{flag=1; next} /```/{flag=0} flag && /^[^#]/ && NF>0' "$plan_file" > "$temp_script"
        
        if [ ! -s "$temp_script" ]; then
            echo -e "${ERROR} No executable commands found in plan file"
            echo -e "${INFO} Plan file should contain bash code blocks with commands"
            exit 1
        fi
        
        echo -e "${INFO} Found execution commands:"
        cat "$temp_script"
        echo ""
        
        read -p "Execute these commands? (y/N): " confirm
        if [[ $confirm != [yY] ]]; then
            echo -e "${INFO} Execution cancelled"
            rm "$temp_script"
            exit 0
        fi
        
        echo -e "${WORKING} Executing breakdown commands..."
        
        # Execute commands with variable tracking
        declare -A ticket_vars
        
        while IFS= read -r cmd; do
            # Skip empty lines and comments
            [[ -z "$cmd" || "$cmd" =~ ^[[:space:]]*# ]] && continue
            
            echo -e "${WORKING} Executing: $cmd"
            
            # Handle variable substitution for ticket IDs
            if [[ $cmd == *"EPIC_ID"* ]] && [[ -n "${ticket_vars[EPIC_ID]}" ]]; then
                cmd=${cmd//EPIC_ID/${ticket_vars[EPIC_ID]}}
            fi
            if [[ $cmd == *"IMPL_PARENT_ID"* ]] && [[ -n "${ticket_vars[IMPL_PARENT_ID]}" ]]; then
                cmd=${cmd//IMPL_PARENT_ID/${ticket_vars[IMPL_PARENT_ID]}}
            fi
            if [[ $cmd == *"RESEARCH_ID"* ]] && [[ -n "${ticket_vars[RESEARCH_ID]}" ]]; then
                cmd=${cmd//RESEARCH_ID/${ticket_vars[RESEARCH_ID]}}
            fi
            if [[ $cmd == *"PARENT_ID"* ]] && [[ -n "${ticket_vars[PARENT_ID]}" ]]; then
                cmd=${cmd//PARENT_ID/${ticket_vars[PARENT_ID]}}
            fi
            
            # Execute command and capture ticket ID
            result=$(eval "$cmd" 2>&1)
            echo "$result"
            
            # Extract ticket ID from result and store in variables
            if [[ $result == *"Created"* ]]; then
                ticket_id=$(echo "$result" | grep -o 'CEN-[0-9]*' | head -1)
                
                # Determine variable name based on ticket type
                if [[ $cmd == *"Epic"* ]]; then
                    ticket_vars[EPIC_ID]=$ticket_id
                    echo -e "${SUCCESS} Stored EPIC_ID=$ticket_id"
                elif [[ $cmd == *"Research"* ]]; then
                    ticket_vars[RESEARCH_ID]=$ticket_id
                    echo -e "${SUCCESS} Stored RESEARCH_ID=$ticket_id"
                elif [[ $cmd == *"Implementation"* ]] && [[ $cmd != *"Component"* ]] && [[ $cmd != *"Integration"* ]]; then
                    ticket_vars[IMPL_PARENT_ID]=$ticket_id
                    ticket_vars[PARENT_ID]=$ticket_id
                    echo -e "${SUCCESS} Stored IMPL_PARENT_ID=$ticket_id"
                else
                    echo -e "${SUCCESS} Created ticket: $ticket_id"
                fi
            fi
            
            echo ""
        done < "$temp_script"
        
        rm "$temp_script"
        
        echo -e "${SUCCESS} ${GREEN}Breakdown execution complete!${NC}"
        echo -e "${INFO} Created tickets:"
        for var in "${!ticket_vars[@]}"; do
            echo -e "${INFO}   $var: ${ticket_vars[$var]}"
        done
        ;;

# Legacy commands (maintained for backward compatibility)
    "epic")
        echo -e "${INFO} Epic breakdown detected"
        echo -e "${INFO} Recommended structure:"
        echo -e "${INFO}   ‚Ä¢ Research phase (1 ticket)"
        echo -e "${INFO}   ‚Ä¢ Implementation parent (1 coordination ticket)"
        echo -e "${INFO}   ‚Ä¢ Implementation subtasks (3-5 focused tickets)"
        
        echo -e "${WORKING} Step 2: Creating epic structure..."
        
        # Create epic parent
        echo -e "${WORKING} Creating epic parent ticket..."
        epic_result=$(./write_ticket research "$title Epic" "Epic to coordinate ${title,,} with sequential research and implementation phases.

## Strategic Value
${description}

## Epic Scope
This epic will be broken down into sequential Research ‚Üí Implementation phases with focused subtasks.

## Structure
- Research phase: Architecture and technical analysis
- Implementation phase: Coordinated development across multiple technical areas")
        
        if [[ $epic_result == *"Created"* ]]; then
            epic_id=$(echo "$epic_result" | grep -o 'CEN-[0-9]*' | head -1)
            echo -e "${SUCCESS} Created epic parent: $epic_id"
            
            # Create research phase
            echo -e "${WORKING} Creating research phase..."
            research_result=$(./write_ticket research "$title Architecture Research" "Research phase to design the technical architecture for $title.

## Objective
Design the technical architecture and implementation approach for the $title project.

## Research Tasks
- Technical stack analysis and selection
- Architecture design and documentation
- Implementation timeline and breakdown
- Integration requirements analysis

## Deliverables
- Technical architecture document
- Implementation roadmap
- Clear specification for implementation phase

## Success Criteria
- Complete technical approach defined
- Implementation tasks clearly scoped
- Architecture decisions documented and justified" "$epic_id")
            
            if [[ $research_result == *"Created"* ]]; then
                research_id=$(echo "$research_result" | grep -o 'CEN-[0-9]*' | head -1)
                echo -e "${SUCCESS} Created research phase: $research_id"
                
                # Create implementation parent
                echo -e "${WORKING} Creating implementation parent..."
                impl_result=$(./write_ticket implementation "$title Implementation" "Parent ticket for implementing $title across multiple technical areas.

## Context
This parent ticket coordinates the implementation phase of the $title project, following the architecture designed in $research_id.

## Prerequisites
- $research_id (Research) must be completed
- Technical architecture document approved
- Implementation specifications finalized

## Implementation Breakdown
The implementation is broken down into focused subtasks that each handle a specific technical area.

## Success Criteria
- All subtasks completed successfully
- Integration across technical areas validated
- Performance and functionality requirements met" "$epic_id")
                
                if [[ $impl_result == *"Created"* ]]; then
                    impl_parent_id=$(echo "$impl_result" | grep -o 'CEN-[0-9]*' | head -1)
                    echo -e "${SUCCESS} Created implementation parent: $impl_parent_id"
                    
                    echo -e "${WARNING} ${YELLOW}Epic structure created successfully!${NC}"
                    echo ""
                    echo -e "${INFO} ${BLUE}=== NEXT ACTIONS ===${NC}"
                    echo -e "${INFO} 1. Create implementation subtasks:"
                    echo -e "${INFO}    ./write_ticket implementation 'Core Framework' 'Foundation components' $impl_parent_id"
                    echo -e "${INFO}    ./write_ticket implementation 'Integration Layer' 'External system integration' $impl_parent_id"
                    echo -e "${INFO}    ./write_ticket implementation 'Business Logic' 'Core functionality' $impl_parent_id"
                    echo -e "${INFO}    (Add 2-3 more specific to your technical areas)"
                    echo ""
                    echo -e "${INFO} 2. Start with research phase:"
                    echo -e "${INFO}    ./assign_ticket $research_id Agent-Sam"
                    echo -e "${BLUE}=========================${NC}"
                else
                    echo -e "${ERROR} Failed to create implementation parent"
                    exit 1
                fi
            else
                echo -e "${ERROR} Failed to create research phase"
                exit 1
            fi
        else
            echo -e "${ERROR} Failed to create epic parent"
            exit 1
        fi
        ;;
        
    "implementation")
        if [ -z "$parent_id" ]; then
            echo -e "${ERROR} Parent ID required for implementation breakdown"
            exit 1
        fi
        
        echo -e "${INFO} Implementation breakdown detected"
        echo -e "${INFO} Converting large implementation ticket to parent + focused subtasks"
        
        echo -e "${WORKING} Step 2: Converting parent ticket..."
        
        # Update parent to be coordination-only
        parent_desc="Parent ticket for implementing $title across multiple technical areas.

## Context
This parent ticket coordinates the implementation of $title, broken down into focused technical subtasks.

## Prerequisites
- Architecture and design phase completed
- Technical specifications available

## Implementation Breakdown
The implementation is broken down into focused subtasks that each handle a specific technical area.

## Success Criteria
- All subtasks completed successfully
- Integration across technical areas validated
- Functionality and performance requirements met"
        
        echo -e "${WORKING} Updating parent ticket description..."
        python3 ./.tools/saber.py description "$parent_id" "$parent_desc"
        echo -e "${SUCCESS} Converted $parent_id to parent ticket"
        
        echo -e "${WARNING} ${YELLOW}Implementation parent updated!${NC}"
        echo ""
        echo -e "${INFO} ${BLUE}=== NEXT ACTIONS ===${NC}"
        echo -e "${INFO} Create focused implementation subtasks:"
        echo -e "${INFO}   ./write_ticket implementation 'Framework Setup' 'Core framework and configuration' $parent_id"
        echo -e "${INFO}   ./write_ticket implementation 'Integration Layer' 'External system integration' $parent_id"
        echo -e "${INFO}   ./write_ticket implementation 'Core Features' 'Primary functionality implementation' $parent_id"
        echo -e "${INFO}   ./write_ticket implementation 'Testing & Validation' 'Test suite and validation' $parent_id"
        echo -e "${INFO} (Customize subtasks based on your specific technical areas)"
        echo -e "${BLUE}=========================${NC}"
        ;;
        
    "split")
        if [ -z "$title" ] || [[ ! "$title" =~ ^CEN-[0-9]+$ ]]; then
            echo -e "${ERROR} Valid ticket ID required for split (e.g., CEN-123)"
            exit 1
        fi
        
        ticket_id="$title"
        echo -e "${INFO} Ticket split breakdown detected"
        echo -e "${INFO} Analyzing $ticket_id for breakdown opportunities..."
        
        # Get ticket details
        ticket_info=$(python3 ./.tools/saber.py get "$ticket_id" 2>/dev/null)
        if [ $? -ne 0 ]; then
            echo -e "${ERROR} Failed to retrieve ticket $ticket_id"
            exit 1
        fi
        
        ticket_title=$(echo "$ticket_info" | jq -r '.title')
        echo -e "${SUCCESS} Found ticket: $ticket_title"
        
        # Validate the ticket
        echo -e "${WORKING} Running validation analysis..."
        validation_result=$(./validate_ticket "$ticket_id" 2>/dev/null)
        
        if [[ $validation_result == *"BREAKDOWN RECOMMENDED"* ]]; then
            echo -e "${WARNING} Validation confirms breakdown needed"
            
            # Convert to parent ticket
            parent_desc="Parent ticket for $ticket_title broken down into focused subtasks.

## Context
This parent ticket coordinates the implementation of $ticket_title, originally identified as too broad for single implementation.

## Implementation Breakdown
The work is broken down into focused subtasks that each handle a specific aspect of the implementation.

## Success Criteria
- All subtasks completed successfully
- Integration across subtasks validated
- Original requirements fully met"
            
            echo -e "${WORKING} Converting to parent ticket..."
            python3 ./.tools/saber.py description "$ticket_id" "$parent_desc"
            echo -e "${SUCCESS} Converted $ticket_id to parent ticket"
            
            echo -e "${WARNING} ${YELLOW}Ticket converted to parent!${NC}"
            echo ""
            echo -e "${INFO} ${BLUE}=== NEXT ACTIONS ===${NC}"
            echo -e "${INFO} Create focused subtasks for the specific areas identified in validation:"
            echo -e "${INFO}   ./write_ticket implementation 'Component A' 'First focused area' $ticket_id"
            echo -e "${INFO}   ./write_ticket implementation 'Component B' 'Second focused area' $ticket_id"
            echo -e "${INFO}   ./write_ticket implementation 'Component C' 'Third focused area' $ticket_id"
            echo -e "${INFO} (Base subtasks on the specific multiple tasks identified by validator)"
            echo -e "${BLUE}=========================${NC}"
        else
            echo -e "${SUCCESS} Ticket validation passed - no breakdown needed"
            echo -e "${INFO} $ticket_id appears to be properly scoped"
        fi
        ;;
        
    *)
        echo -e "${ERROR} Unknown breakdown type: $breakdown_type"
        echo -e "${INFO} Supported types: epic, implementation, split"
        exit 1
        ;;
esac

echo ""
echo -e "${SUCCESS} ${GREEN}Bulk breakdown process complete!${NC}"
echo -e "${INFO} Remember to run validation on any newly created tickets"