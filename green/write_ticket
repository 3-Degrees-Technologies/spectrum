#!/bin/bash
# write_ticket command for Agent-Knowledge
# Automates: Agent brief -> Template selection -> Ticket creation -> Auto-validation

# Colors and emoji
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'
SUCCESS="‚úÖ"
ERROR="‚ùå"
WARNING="‚ö†Ô∏è"
INFO="üìã"
WORKING="üîÑ"
INPUT="üìù"
CREATE="üé´"
VALIDATE="‚ú®"
TEMPLATE="üìÑ"

# Usage check
if [ $# -lt 3 ]; then
    echo -e "${ERROR} Usage: ./write_ticket <type> <title> <brief> [parent_id]"
    echo -e "${INFO} Types: research, design, implementation"
    echo -e "${INFO} Example: ./write_ticket implementation 'JWT Middleware' 'Need JWT validation middleware' SPE-9"
    exit 1
fi

type_input="$1"
ticket_title="$2"
agent_brief="$3"
parent_id="$4"

# Map type names
case $type_input in
    "research"|"1") ticket_type=1; type_name="Research" ;;
    "design"|"2") ticket_type=2; type_name="Design" ;;
    "implementation"|"3") ticket_type=3; type_name="Implementation" ;;
    *) echo -e "${ERROR} Invalid type. Use: research, design, or implementation"; exit 1 ;;
esac

echo -e "${INFO} ${BLUE}Agent-Knowledge Ticket Creation Framework${NC}"
echo -e "${CREATE} Creating ${type_name} ticket: ${ticket_title}"
echo -e "${INFO} Brief: ${agent_brief}"
if [ -n "$parent_id" ]; then
    echo -e "${INFO} Parent: ${parent_id}"
fi
echo ""

# Step 2: Apply domain context and templates
echo -e "${TEMPLATE} Applying ${type_name} template..."
echo -e "${WORKING} Generating ticket content..."

# Generate ticket description based on type
case $ticket_type in
    1) # Research Template
        ticket_description="# ${ticket_title}

**Objective**
Research and analyze ${agent_brief} to provide foundation for design and implementation decisions.

**Context**
${agent_brief} requires thorough analysis to understand current patterns, identify best approaches, and establish requirements for future implementation.

**Task**
Conduct comprehensive research on ${agent_brief}:

* Analyze existing Centro patterns and implementations
* Research industry best practices and approaches
* Identify integration points with current architecture
* Document findings with concrete recommendations
* Establish requirements and constraints for future phases

**Key Research Areas**

* **Existing Patterns**: How is similar functionality currently implemented in Centro?
* **Integration Points**: What existing systems need to integrate with this functionality?
* **Best Practices**: What are the recommended approaches in the industry?
* **Constraints**: What technical and business constraints affect implementation?
* **Requirements**: What functional and non-functional requirements need to be met?

**Success Criteria**

* Current Centro patterns documented and analyzed
* Industry best practices researched and compared
* Integration requirements identified and documented
* Technical constraints and considerations documented
* Clear recommendations provided for design phase
* Research findings ready for design phase planning

**Labels**
research"
        ;;
    2) # Design Template
        ticket_description="# ${ticket_title}

**Objective**
Define the functional requirements and integration patterns for ${agent_brief}.

**Context**
Based on research findings, this design phase explores what ${agent_brief} should functionally accomplish and how it integrates with existing Centro systems.

**Task**
Explore and define the functional integration patterns for ${agent_brief}:

* How should this functionality integrate with existing Centro patterns?
* What contracts and interfaces should be defined?
* How should error handling and edge cases be managed?
* What operational visibility and monitoring is needed?
* How should this fit with existing Centro architectural patterns?

**Key Functional Questions to Answer**

* **Integration Flow**: What is the expected workflow and integration points?
* **Contracts**: What interfaces and contracts need to be defined?
* **Error Handling**: What failure modes exist and how should recovery work?
* **Observability**: What information do operators need for monitoring and debugging?
* **Centro Patterns**: How does this align with existing Centro architectural patterns?

**Success Criteria**

* Functional workflow defined with clear integration points
* Contracts and interfaces specified for consistent behavior
* Error handling and recovery patterns specified
* Operational monitoring and debugging requirements identified
* Integration approach with existing Centro systems documented
* Functional requirements ready for implementation planning

**Labels**
design"
        ;;
    3) # Implementation Template
        ticket_description="# ${ticket_title}

**Objective**
Implement ${agent_brief} following test-driven development approach.

**Context**
Based on design specifications, implement the functionality with focus on correctness and integration with existing Centro systems.

**Task**
Implement ${agent_brief} using TDD methodology:

* Write tests covering functional requirements
* Implement core functionality following Centro patterns
* Add error handling for edge cases
* Add logging and monitoring instrumentation
* Validate integration with existing systems

**Implementation Approach**

* Follow test-driven development with comprehensive test coverage
* Use existing Centro patterns and conventions
* Ensure clean integration with existing Centro architecture

**Definition of Done**

* Tests written and passing for all functionality
* Core functionality implemented following Centro patterns
* Error handling implemented for identified failure modes
* Integration with existing systems validated
* Code review completed and approved

**Labels**
backend, implementation"
        ;;
esac

# Step 3: Create ticket
echo -e "${CREATE} Creating ticket in Linear..."
echo -e "${WORKING} Creating ${type_name} ticket: ${ticket_title}"

# Create the ticket
create_result=$(python3 .tools/saber.py create "$ticket_title" "$ticket_description" 2>/dev/null)
if [ $? -ne 0 ]; then
    echo -e "${ERROR} Failed to create ticket"
    exit 1
fi

# Helper function to get project prefix
get_project_prefix() {
    local config_file=".spectrum/linear_config.json"
    if [ -f "$config_file" ]; then
        python3 -c "import json; print(json.load(open('$config_file'))['project_prefix'])" 2>/dev/null || echo "SPE"
    else
        # Get from saber and create config if missing
        python3 .tools/saber.py config >/dev/null 2>&1
        if [ -f "$config_file" ]; then
            python3 -c "import json; print(json.load(open('$config_file'))['project_prefix'])" 2>/dev/null || echo "SPE"
        else
            echo "SPE"  # fallback
        fi
    fi
}

# Extract ticket ID from result using stored prefix
project_prefix=$(get_project_prefix)
ticket_id=$(echo "$create_result" | grep -oE "${project_prefix}-[0-9]+" | head -1)
if [ -z "$ticket_id" ]; then
    echo -e "${ERROR} Could not extract ticket ID from creation result"
    echo -e "${INFO} Create result: $create_result"
    echo -e "${INFO} Expected pattern: ${project_prefix}-XXX"
    exit 1
fi

echo -e "${SUCCESS} Created ticket: ${ticket_id}"

# Set parent relationship if provided
if [ -n "$parent_id" ]; then
    echo -e "${WORKING} Setting parent relationship to ${parent_id}..."
    parent_result=$(python3 .tools/saber.py parent "$ticket_id" "$parent_id" 2>/dev/null)
    if [ $? -eq 0 ]; then
        echo -e "${SUCCESS} Parent relationship set"
    else
        echo -e "${WARNING} Failed to set parent relationship"
    fi
fi

# Step 4: Auto-validate created ticket
echo -e "${VALIDATE} Auto-validating created ticket..."
echo -e "${WORKING} Running validation on ${ticket_id}..."

# Run validation script if it exists
if [ -f "./validate_ticket" ]; then
    echo ""
    ./validate_ticket "$ticket_id"
    validation_exit_code=$?
    echo ""
    
    if [ $validation_exit_code -eq 0 ]; then
        echo -e "${SUCCESS} Ticket validation passed"
    else
        echo -e "${WARNING} Ticket validation found issues - consider refinement"
    fi
else
    echo -e "${INFO} Validation script not found, skipping auto-validation"
fi

# Step 5: Creation complete
echo -e "${SUCCESS} ${GREEN}Ticket Creation Complete!${NC}"
echo -e "${INFO} Ticket ID: ${ticket_id}"
echo -e "${INFO} Title: ${ticket_title}"
echo -e "${INFO} Type: ${type_name}"
if [ -n "$parent_id" ]; then
    echo -e "${INFO} Parent: ${parent_id}"
fi
echo -e "${INFO} Linear URL: https://linear.app/3-degrees-technologies/issue/${ticket_id}"
echo -e "${BLUE}Ticket ready for assignment!${NC}"