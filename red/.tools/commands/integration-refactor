#!/bin/bash
# integration-refactor command for Centro Development Framework
# Implements: Integration Test REFACTOR cycle - Enhance and clean up the test

# Colors and emoji
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'
SUCCESS="âœ…"
ERROR="âŒ"
INFO="ğŸ“‹"
WORKING="ğŸ”„"
TEST="ğŸ§ª"
INTEGRATION="ğŸ”—"

echo -e "${TEST} ${BLUE}INTEGRATION REFACTOR CYCLE${NC}: Enhancing the test"

# Check if we have a test state
SPECTRUM_STATE_DIR=".spectrum/state"
SPECTRUM_TMP_DIR=".spectrum/tmp"
INTEGRATION_STATE_FILE="$SPECTRUM_STATE_DIR/integration-test-state.json"

# Ensure Spectrum directory structure exists
mkdir -p "$SPECTRUM_STATE_DIR" "$SPECTRUM_TMP_DIR"

if [[ ! -f "$INTEGRATION_STATE_FILE" ]]; then
    echo -e "${ERROR} No integration test state found. Please run ./integration-red first"
    exit 1
fi

# Read test state
test_file=$(jq -r '.test_file' "$INTEGRATION_STATE_FILE")
test_description=$(jq -r '.test_description' "$INTEGRATION_STATE_FILE")
phase=$(jq -r '.phase' "$INTEGRATION_STATE_FILE")

echo -e "${INFO} Test: $test_description"
echo -e "${INFO} File: $test_file"
echo -e "${INFO} Current phase: $phase"

if [[ "$phase" != "green" ]]; then
    echo -e "${ERROR} Test is not in GREEN phase. Please run ./integration-green first"
    exit 1
fi

echo -e "\n${INTEGRATION} ${YELLOW}Integration Test Refactoring Options${NC}"

echo -e "${INFO} What would you like to enhance?"
echo "1) Add more comprehensive assertions"
echo "2) Add error handling and edge cases"
echo "3) Add performance/timing validation"
echo "4) Add better test documentation"
echo "5) Add setup/teardown steps"
echo "6) Add multiple test scenarios"
echo "7) All of the above"
read -p "Select enhancement (1-7): " enhancement_choice

echo -e "\n${WORKING} Refactoring suggestions:"

case $enhancement_choice in
    1|7) # More assertions
        echo -e "${INFO} Add comprehensive assertions:"
        echo -e "  âœ… Validate all required response fields"
        echo -e "  âœ… Check data types and formats"
        echo -e "  âœ… Verify business logic correctness"
        echo -e "  âœ… Test boundary conditions"
        ;;
esac

case $enhancement_choice in
    2|7) # Error handling
        echo -e "${INFO} Add error handling tests:"
        echo -e "  âŒ Test invalid inputs"
        echo -e "  âŒ Test service unavailable scenarios"
        echo -e "  âŒ Test timeout conditions"
        echo -e "  âŒ Test malformed requests"
        ;;
esac

case $enhancement_choice in
    3|7) # Performance
        echo -e "${INFO} Add performance validation:"
        echo -e "  â±ï¸ Measure response times"
        echo -e "  â±ï¸ Test under load"
        echo -e "  â±ï¸ Validate timeout handling"
        ;;
esac

case $enhancement_choice in
    4|7) # Documentation
        echo -e "${INFO} Enhance documentation:"
        echo -e "  ğŸ“ Add clear test purpose"
        echo -e "  ğŸ“ Document expected behavior"
        echo -e "  ğŸ“ Add troubleshooting notes"
        echo -e "  ğŸ“ Document dependencies"
        ;;
esac

case $enhancement_choice in
    5|7) # Setup/teardown
        echo -e "${INFO} Add setup/teardown:"
        echo -e "  ğŸ”§ Pre-test environment setup"
        echo -e "  ğŸ”§ Test data preparation"
        echo -e "  ğŸ”§ Post-test cleanup"
        echo -e "  ğŸ”§ Resource management"
        ;;
esac

case $enhancement_choice in
    6|7) # Multiple scenarios
        echo -e "${INFO} Add test scenarios:"
        echo -e "  ğŸ¯ Happy path variations"
        echo -e "  ğŸ¯ Different input combinations"
        echo -e "  ğŸ¯ Various user contexts"
        echo -e "  ğŸ¯ Different environment states"
        ;;
esac

echo -e "\n${INFO} Refactoring guidelines:"
echo -e "  1. Keep tests focused and single-purpose"
echo -e "  2. Make assertions clear and descriptive"
echo -e "  3. Add meaningful console.log() for debugging"
echo -e "  4. Use consistent naming conventions"
echo -e "  5. Document test dependencies and setup requirements"

echo -e "\n${INFO} Example refactored test structure:"
cat << 'EOF'
tests {
  test("Service should be healthy and operational", function() {
    // Validate basic health
    expect(res.getStatus()).to.equal(200);
    
    // Validate response structure
    const body = res.getBody();
    expect(body).to.have.property('services');
    
    // Validate specific service status
    expect(body.services.lambda).to.equal('running');
    
    // Log for debugging
    console.log("âœ… Lambda service operational");
    console.log("ğŸ” Available services:", Object.keys(body.services));
  });
  
  test("Service should handle errors gracefully", function() {
    // Add error scenario testing
  });
}
EOF

echo -e "\n${TEST} After refactoring:"
echo -e "  1. Run the test to ensure it still passes"
echo -e "  2. Verify all new assertions work correctly" 
echo -e "  3. Check that error scenarios fail appropriately"
echo -e "  4. Review test documentation completeness"

# Update test state
jq '.phase = "refactor"' $INTEGRATION_STATE_FILE > $INTEGRATION_STATE_FILE.tmp
mv $INTEGRATION_STATE_FILE.tmp $INTEGRATION_STATE_FILE

echo -e "\n${SUCCESS} Integration test ready for refactoring!"
echo -e "${INFO} Edit: $test_file"