#!/bin/bash
# Spectrum AI Agent Launcher for Workspace-Based Development

set -e

# Load agent names from configuration
get_agent_name() {
    local color="$1"
    if [[ -f ".spectrum/agent-names.json" ]]; then
        # Try to extract agent name from JSON
        local agent_key="AGENT_${color^^}"  # Convert to uppercase
        if command -v jq >/dev/null 2>&1; then
            jq -r ".$agent_key // \"Agent-${color^}\"" .spectrum/agent-names.json 2>/dev/null || echo "Agent-${color^}"
        else
            # Fallback: simple grep extraction
            grep "\"$agent_key\"" .spectrum/agent-names.json 2>/dev/null | sed 's/.*": *"\([^"]*\)".*/\1/' || echo "Agent-${color^}"
        fi
    else
        echo "Agent-${color^}"
    fi
}

# Parse command
if [[ $# -lt 1 ]]; then
    echo "Usage: agent <color>"
    echo ""
    echo "Spectrum AI Agent Conventions:"
    echo "  green   ‚Üí $(get_agent_name green) in ."
    echo "  red     ‚Üí $(get_agent_name red) in ./red"
    echo "  blue    ‚Üí $(get_agent_name blue) in ./blue"
    exit 1
fi

AGENT_COLOR="$1"

# Handle scarlet alias
if [[ "$AGENT_COLOR" == "scarlet" ]]; then
    AGENT_COLOR="red"
fi

# Convention-based directory mapping
case "$AGENT_COLOR" in
    "green")
        AGENT_NAME="$(get_agent_name green)"
        WORK_DIR="."
        ;;
    "red")  
        AGENT_NAME="$(get_agent_name red)"
        WORK_DIR="./red"
        # Ensure red directory exists
        if [[ ! -d "./red" ]]; then
            echo "üìÅ Creating red directory for $AGENT_NAME..."
            mkdir -p "./red"
        fi
        ;;
    "blue")
        AGENT_NAME="$(get_agent_name blue)"
        WORK_DIR="./blue"
        # Ensure blue directory exists
        if [[ ! -d "./blue" ]]; then
            echo "üìÅ Creating blue directory for $AGENT_NAME..."
            mkdir -p "./blue"
        fi
        ;;
    "black")
        AGENT_NAME="$(get_agent_name black)"
        WORK_DIR="./blue"
        # Ensure blue directory exists (black uses blue directory)
        if [[ ! -d "./blue" ]]; then
            echo "üìÅ Creating blue directory for $AGENT_NAME..."
            mkdir -p "./blue"
        fi
        ;;
    *)
        echo "‚ùå Unknown agent: $AGENT_COLOR"
        echo "Available: green, red, scarlet, blue, black"
        exit 1
        ;;
esac

echo "ü§ñ Starting OpenCode session with $AGENT_NAME..."
echo "üìÅ Working directory: $WORK_DIR"

# Check if opencode is available
if ! command -v opencode >/dev/null 2>&1; then
    echo "‚ùå OpenCode not found in PATH"
    echo "   Please ensure OpenCode is installed and available in your PATH"
    exit 1
fi

# Change to the agent's working directory and start OpenCode
cd "$WORK_DIR"

# Add .tools directory to PATH if it exists
if [[ -d ".tools" ]]; then
    export PATH="$(pwd)/.tools:$PATH"
fi

echo "üöÄ Starting OpenCode in $(pwd)..."
exec opencode
